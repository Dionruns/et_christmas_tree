# 缓存优化说明

## 为什么需要缓存优化？

每次刷新网页都会重新加载所有图片、音频等资源，这会导致：
- CDN 流量消耗大
- 加载速度慢
- 用户体验差

## 已实现的缓存策略

### 1. HTTP 缓存头（`_headers` 文件）

为 Cloudflare Pages 配置了缓存策略：

- **静态资源**（图片、音频、字体等）：缓存 1 年
  - `Cache-Control: public, max-age=31536000, immutable`
  - 浏览器会缓存这些文件，下次访问直接从本地读取
  
- **HTML 文件**：缓存 1 小时
  - `Cache-Control: public, max-age=3600, must-revalidate`
  - 保证内容更新能及时生效

### 2. Service Worker 缓存

实现了更强大的离线缓存：

- **缓存优先策略**：优先从缓存读取，没有缓存才从网络加载
- **自动缓存**：首次加载后自动缓存所有静态资源
- **离线支持**：即使断网也能访问已缓存的内容

### 3. 浏览器原生缓存

利用浏览器的 HTTP 缓存机制：
- 图片、音频等资源会被浏览器自动缓存
- 相同 URL 的资源不会重复下载

## 效果

### 首次访问
- 需要下载所有资源（约 27 张照片 + 音频 + 其他资源）
- CDN 流量消耗：完整资源大小

### 再次访问（刷新页面）
- 大部分资源从浏览器缓存读取
- CDN 流量消耗：几乎为 0（只有 HTML 和未缓存的资源）

### 预期节省
- **第二次访问起**：节省 95%+ 的 CDN 流量
- **加载速度**：提升 80%+

## 验证缓存是否生效

### 方法 1：浏览器开发者工具
1. 打开浏览器开发者工具（F12）
2. 切换到 "Network" 标签
3. 刷新页面
4. 查看资源的 "Size" 列：
   - 显示 `(disk cache)` 或 `(memory cache)` = 缓存生效 ✅
   - 显示实际大小（如 500 KB）= 从网络下载 ❌

### 方法 2：查看响应头
1. 在 Network 标签中点击任意图片资源
2. 查看 "Headers" 标签
3. 找到 `Cache-Control` 响应头
4. 应该看到：`public, max-age=31536000, immutable`

### 方法 3：Service Worker 状态
1. 打开开发者工具的 "Application" 标签
2. 左侧选择 "Service Workers"
3. 应该看到 `/sw.js` 状态为 "activated and is running"

## 清除缓存（开发调试用）

如果需要强制重新加载所有资源：

### 方法 1：硬刷新
- Windows/Linux: `Ctrl + Shift + R` 或 `Ctrl + F5`
- Mac: `Cmd + Shift + R`

### 方法 2：清除浏览器缓存
1. 打开开发者工具（F12）
2. 右键点击刷新按钮
3. 选择 "清空缓存并硬性重新加载"

### 方法 3：清除 Service Worker
1. 开发者工具 → Application → Service Workers
2. 点击 "Unregister" 注销 Service Worker
3. 刷新页面

## 注意事项

1. **更新资源**：如果更新了图片，需要修改文件名或 URL 才能让用户看到新版本
2. **缓存版本**：Service Worker 的 `CACHE_NAME` 需要在更新时修改版本号
3. **测试环境**：开发时可以在开发者工具中勾选 "Disable cache" 来禁用缓存

## CDN 流量估算

假设：
- 单次完整加载：约 10 MB（27 张照片 + 音频 + 其他资源）
- 每天访问量：1000 次
- 缓存命中率：95%

### 无缓存优化
- 每天流量：1000 × 10 MB = 10 GB
- 每月流量：10 GB × 30 = 300 GB

### 有缓存优化
- 首次访问（5%）：50 × 10 MB = 500 MB
- 再次访问（95%）：950 × 0.5 MB = 475 MB（只加载 HTML 等小文件）
- 每天流量：975 MB ≈ 1 GB
- 每月流量：1 GB × 30 = 30 GB

**节省流量：270 GB/月（90%）** 🎉
